//Global variables are definitely OK
var markers;
var lonLat;
var zoom;

$(document).ready(function() {
    main();
});

function main() {
    /*map = new OpenLayers.Map("mainMap");
    map.addLayer(new OpenLayers.Layer.OSM());
    map.zoomToMaxExtent();

    /*lonLat = new OpenLayers.LonLat(0, 0)
	.transform(
		new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
		map.getProjectionObject() // to Spherical Mercator Projection
		);
    zoom=0;
    console.log(lonLat);

    // A popup with some information about our location	 
    var popup = new OpenLayers.Popup.FramedCloud("Popup", 
	    lonLat, null,
   	    '<a target="_blank" href="http://openlayers.org/">We</a> ' +
	    'could be here.<br>Or elsewhere.', null,
	    true // <-- true if we want a close (X) button, false otherwise
	    );

    markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);
		     
    //markers.addMarker(new OpenLayers.Marker(lonLat));

    //var dialog = "Oh, hey there. I'm an event. Nearly. ";
    //addMarker(lonLat, dialog);
    
    //markers.addMarker(new OpenLayers.Marker(lonLat));

    map.setCenter(lonLat, zoom);

    //setup various stuff
    //init();
    

    navigator.geolocation.getCurrentPosition(function(position) {       
    var lonLat = new OpenLayers.LonLat(position.coords.longitude,
	position.coords.latitude)
	.transform(
	    new OpenLayers.Projection("EPSG:4326"), //transform from WGS 1984
	    map.getProjectionObject() //to Spherical Mercator Projection
	    );

    markers.addMarker(new OpenLayers.Marker(lonLat));

    map.setCenter(lonLat, 14 // Zoom level
	);
    });

    map.setCenter(new
	    OpenLayers.LonLat(3,3) // Center of the map
	    .transform(
		new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
		new OpenLayers.Projection("EPSG:900913") // to Spherical Mercator Projection
		), 15 // Zoom level
	    );*/
}

function init() {
    //setup Set form
    $( "#shareButton" )
	.button()
	.click(function() {
	    if(navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(function(pos) {
		     lonLat = new OpenLayers.LonLat(pos.coords.longitude, pos.coords.latitude)
		    .transform(
			new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
			map.getProjectionObject() // to Spherical Mercator Projection
			);
		});

		zoom = 16;

		map.setCenter(lonLat, zoom); // 0=relative zoom level
	    } 
	});
}

function addMarker(lonLat, dialog) {
    markers.addMarker(new OpenLayers.Marker(lonLat));
    
    var popup = new OpenLayers.Popup.FramedCloud("Popup", 
	    lonLat, null,
   	    '<a target="_blank" href="http://openlayers.org/"></a> ' +
	    dialog, null,
	    true // <-- true if we want a close (X) button, false otherwise
	    );
    map.addPopup(popup);
}

function getLocation() {
    if(navigator.geolocation) {
	loc = {lon: 0, lat: 0};
	navigator.geolocation.getCurrentPosition(function(pos) {
	    loc.lon = pos.coords.longitude;
	    loc.lat = pos.coords.latitude;
	    return loc;
	});
    } else {
	alert("Your browser does not support, or has not got enabled, geolocation :(");
    }

    return loc;
}

function parseForm() {
    var form = $('#lonLat');
    form.submit(function () {
	$.ajax({
	    type: form.attr('method'),
	    url: form.attr('action'),
	    data: form.serialize(),
	    success: function (data) {
		//var lonLat = $.parseJSON(data);
		//alert(lonLat.name === "lon");
	    }
	});
	return false;
    });
}
	
